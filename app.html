<!DOCTYPE HTML>
<!--
	Projection by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>

<head>
	<!-- Hotjar Tracking Code for virufy.org -->
	<script>
	    (function(h,o,t,j,a,r){
	        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
	        h._hjSettings={hjid:1878866,hjsv:6};
	        a=o.getElementsByTagName('head')[0];
	        r=o.createElement('script');r.async=1;
	        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
	        a.appendChild(r);
	    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
	</script>

	<title>Virufy - App</title>

	<!-- Metatags -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Crowdsourced AI-based COVID-19 Detection">
	<meta name="author" content="Team Virufy">

	<link rel="stylesheet" href="assets/css/main.css" />
	<link rel="stylesheet" href="assets/css/header.css" />
		<script src="https://kit.fontawesome.com/828decba15.js" crossorigin="anonymous"></script>

	<!--Sweet Alert-->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.css" rel="stylesheet" />

	<!-- Favicon -->
	<link rel="icon" href="images/logo.png" type="image/x-icon" />
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-165690517-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];

		function gtag() {
			dataLayer.push(arguments);
		}
		gtag('js', new Date());

		gtag('config', 'UA-165690517-1');

	</script>

</head>

<body>

	<!-- Header -->
	<header id="header">
		<div class="inner">
			<a href="index.html" class="logo">
				<img src="images/logo.png">
			</a>
			<nav id="nav">
				<a href="index.html" data-i18n="nav.home"></a>
				<a href="./index.html#about" data-i18n="nav.about"></a>
				<a href="./app.html" data-i18n="nav.app"></a>
				<a href="./research.html" data-i18n="nav.research"></a>
				<a href="data.html" data-i18n="nav.openData"></a>
				<a href="./team.html" data-i18n="nav.team"></a>
				<a href="./goals.html" data-i18n="nav.goals"></a>
				<a href="./join.html" data-i18n="nav.joinUs"></a>
				<a href="./oyw.html" data-i18n="nav.oneYoungWorld"></a>
				<a href="https://blog.virufy.org/"ã€€data-i18n="nav-blog"></a>
				<a href="https://www.gofundme.com/f/virufyorg" target="_blank">
					<button data-i18n="nav.donate"></button>
				</a>

				<div class="language-toggle">
					<select id="language-toggle-select" name="language" id="language">
						<option value="en" data-i18n="languageToggle.en"></option>
						<option value="jp" data-i18n="languageToggle.jp"></option>
						<option value="pt" data-i18n="languageToggle.pt"></option>
					</select>
				</div>

			</nav>
			<a href="#navPanel" class="navPanelToggle"><span class="fa fa-bars"></span></a>
		</div>
	</header>

	<!-- Banner - Message and icon -->
	<section id="app-banner">
		<div class="inner">
			<header>
				<h1 data-i18n="appBanner.title">Virufy COVID-19 (Beta)</h1>
			</header>
		</div>
	</section>


	<!-- Main -->
	<section id="main" class="wrapper">
		<div class="inner">
			<!--
			<div class="scroll">
				<a class="show-mobile" href="#disclaimer">Go to form</a>
			</div>
			<br>
		-->
			<p style="color: #444; font-size: 1.3em;" data-i18n="main.ask">
			</p>

			<form method="POST" enctype="multipart/form-data" id="myForm">
				<div>
					<p id="step">Step 1 - Consent to the study</p>
				</div>
				<p id="disclaimer">We care about privacy. We are advised by licensed data privacy experts and will anonymize all
					information and recordings.</p>
				<br>
				<!--Consent Question -->
				<div class="form-group">
						<label for="consent">Do you consent to participating in this research? (<a href="consent_form.pdf" target=_blank>consent form</a>)<span class="is-required">*</span></label>
						<!-- Add consent form here -->
				</div>
				<div class="form-check form-check-inline" style="margin-left: 5px">
            <input class="form-check-input"type="radio" name="consent" id="consent_yes" value="yes">
            <label class="form-check-label" for="consent_yes" style="margin-left: 3px">Yes</label>
        </div>

				<div class="form-check form-check-inline" style="margin-left: 5px">
            <input class="form-check-input" type="radio" name="consent" id="consent_no" value="no">
            <label class="form-check-label" for="consent_no" style="margin-left: 3px">No</label>
        </div>

				<br/>

				<div>
					<p id="step">Step 2 - Record speech</p>
				</div>
					<p id="disclaimer"> Please press record and count clearly from one to
						ten. This will help us match the volume of your cough to the rest of
						our data.
					</p>
					<br>

				<!-- Count -->
				<div class="row uniform">
					<div id="count">
						<div id="recording-now"></div>
						<button id="recordButtonCount">Record</button>
						<button id="pauseButtonCount" disabled>Pause</button>
						<button id="stopButtonCount" disabled>Stop</button>

					</div>
				</div>
				<p><strong>Recordings:</strong></p>
				<ol id="recordingsListCount"></ol>

				<div>
					<p id="step">Step 3 - Record cough</p>
				</div>
					<p id="disclaimer"> Please cough intentionally for 10 seconds (around 3 times). Force a
						 cough if you do not have one. A timer will appear after you hit the
						 record button.
					</p>
					<br>

				<!-- Cough -->
				<div class="row uniform">
					<div id="cough">
						<div id="displayTimer"></div>
						<button id="recordButton">Record</button>
						<button id="pauseButton" disabled>Pause</button>
						<button id="stopButton" disabled>Stop</button>

					</div>
				</div>
				<p><strong>Recordings:</strong></p>
				<ol id="recordingsList2"></ol>

				<div>
					<p id="step">Step 4 - Answer questions</p>
				</div>
				<p id="disclaimer">Please answer some questions to help our AI understand
					 your cough.</p>
				<br>
				<!-- Covid Condition -->
				<div class="form-group">
						<label for="condition">Which of the following best describes you?</label>
									<div class="form-check form-check-inline" style="margin-left: 5px">
												<input class="form-check-input" type="radio" name="condition" id="condition_positive" value="positive">
												<label class="form-check-label" for="condition_positive" style="margin-left: 3px">I have tested positive for COVID-19</label>
									</div>
									<div class="form-check form-check-inline" style="margin-left: 5px">
												<input class="form-check-input" type="radio" name="condition" id="condition_negative" value="negative">
												<label class="form-check-label" for="condition_negative" style="margin-left: 3px">I have tested negative for COVID-19</label>
									</div>
									<div class="form-check form-check-inline" style="margin-left: 5px">
												<input class="form-check-input" type="radio" name="condition" id="condition_pending" value="pending">
												<label class="form-check-label" for="condition_pending" style="margin-left: 3px">My test result is pending</label>
									</div>
									<div class="form-check form-check-inline" style="margin-left: 5px">
												<input class="form-check-input" type="radio" name="condition" id="condition_untested" value="pending">
												<label class="form-check-label" for="condition_untested" style="margin-left: 3px">I have not been tested for COVID-19</label>
									</div>
				</div>
				<br/>

				<!-- PCR Test -->
				<div class="form-group">
						<label for="test">How long ago were you tested?</label>
									<div class="form-check form-check-inline" style="margin-left: 5px">
												<input class="form-check-input" type="radio" name="test" id="test-15-days" value="15-days">
												<label class="form-check-label" for="test-15-days" style="margin-left: 3px">Within the last 15 days</label>
									</div>
									<div class="form-check form-check-inline" style="margin-left: 5px">
												<input class="form-check-input" type="radio" name="test" id="test-greater-than-15-days" value="greater-than-15-days">
												<label class="form-check-label" for="test-greater-than-15-days" style="margin-left: 3px">More than 15 days ago</label>
									</div>
									<div class="form-check form-check-inline" style="margin-left: 5px">
												<input class="form-check-input" type="radio" name="test" id="test-untested" value="untested">
												<label class="form-check-label" for="test-untested" style="margin-left: 3px">Not tested</label>
									</div>
				</div>
				<br/>


				<!-- Age Question -->
				<div class="row uniform">
					<div class="6u 12u$(xsmall)">
						<label for="age">Please enter your age group:</label>
						<select id="age" name="age">
							<option value="no-value" selected disabled>Select age</option>
							<option value="0-19">Under 20</option>
							<option value="20-29">20-29</option>
							<option value="30-39">30-39</option>
							<option value="40-49">40-49</option>
							<option value="50-59">50-59</option>
							<option value="60-69">60-69</option>
							<option value="70+">70+</option>
						</select>
					</div>
				</div>
				<br/>

				<!-- Gender -->
				 				<div class="form-group">
				             <label for="gender">What is your biological sex?</label>
										 			<div class="form-check form-check-inline" style="margin-left: 5px">
				                         <input class="form-check-input" type="radio" name="gender" id="gender_female" value="female">
				                         <label class="form-check-label" for="gender_female" style="margin-left: 3px">Female</label>
				                   </div>
													<div class="form-check form-check-inline" style="margin-left: 5px">
				                     			<input class="form-check-input" type="radio" name="gender" id="gender_male" value="male">
				                      		<label class="form-check-label" for="gender_male" style="margin-left: 3px">Male</label>
				 									</div>
				         </div>
				 				<br/>

			  <!--Country-->
				<div class="row uniform">
 					<div class="6u 12u$(xsmall)">
 						<label for="country-of-origin">Where are you now?</label>
 							<select name="country" id="country">
 								<option value="" disabled selected>Select country</option>
 								<option data-countrycode="BR
 													data-tokens=" br="" brazil"="" value="BR">Brazil</option>
 								<option data-countrycode="US
 													data-tokens=" us="" united="" states="" of="" america"="" value="US">United States of America</option>
 								<option data-countrycode="OT
 													data-tokens=" ot="" other"="" value="OT">Other</option>
							</select>
					</div>
 				</div>
 				<br>

				<!-- Smoker/Nonsmoker -->
				<div class="12u 12u$(small)">
						<label></span>Have you smoked regularly within the last ten years?<span class="is-required">*</span></label>
				</div>

				<div class="12u 12u$(small)" style="margin-left: 5px">
						<input type="radio" id="Y" name="smoker" value="Yes">
						<label for="Y">Yes</label>
				</div>

				<div class="12u 12u$(small)" style="margin-left: 5px">
						<input type="radio" id="N" name="smoker" value="No">
						<label for="N">No</label>
				</div>

				<br/>
				<!-- Break -->
                <div id="sym-checkbox-wrapper" class="row uniform">
                    <div class="6u 12u$(small)">
                        <label>Which of the symptoms below do you currently have?</label>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip1" name="reported_symptoms1"
                               value="New or worsening cough">
                        <label for="roundtrip1">New or worsening cough</label>
                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip2" name="reported_symptoms2"
                               value="Shortness of breath">
                        <label for="roundtrip2">Shortness of breath</label>

                        <br>
                        <input class="sym-checkbox" type="checkbox" id="roundtrip3" name="reported_symptoms3"
                               value="Fever, chills, or sweating">
                        <label for="roundtrip3"> Fever, chills, or sweating</label>
                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip4" name="reported_symptoms4"
                               value="Sore throat">
                        <label for="roundtrip4">Sore throat</label>
                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip5" name="reported_symptoms5"
                               value="Body aches">
                        <label for="roundtrip5">Body aches</label>

                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip7" name="reported_symptoms7"
                               value="Loss of taste">
                        <label for="roundtrip7">Loss of taste</label>
                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip8" name="reported_symptoms8"
                               value="Loss of smell">
                        <label for="roundtrip8">Loss of smell</label>
                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip9" name="reported_symptoms9"
                               value="Vomiting or diarrhea">
                        <label for="roundtrip9">Vomiting or diarrhea</label>
                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip10" name="reported_symptoms10"
                               value="Tightness in chest">
                        <label for="roundtrip10">Tightness in chest</label>
                        <br>

                        <input class="sym-checkbox" type="checkbox" id="roundtrip11" name="reported_symptoms11"
                               value="Headaches">
                        <label for="roundtrip11">Headaches</label>
                        <br>

                        <input class="sym-checkbox sym-none" type="checkbox" id="roundtrip12"
                               name="reported_symptoms12" value="None">
                        <label for="roundtrip12">None</label>

                    </div>
                </div>
				<!-- Break -->
				<br>
				<br>
				<!-- Break -->
				<div id="sym-checkbox-wrapper" class="row uniform">
 					<div class="6u 12u$(small)">
 						<label></span>Please share your medical history</label>

 						<input class="sym-checkbox" type="checkbox" id="roundtrip01" name="medical_history1" value="Asthma or chronic lung disease">
 						<label for="roundtrip01">Asthma or chronic lung disease</label>
 						<br>

 						<input class="sym-checkbox" type="checkbox" id="roundtrip02" name="medical_history2" value="Pregnancy">
 						<label for="roundtrip02">Pregnancy</label>

 						<br>
 						<input class="sym-checkbox" type="checkbox" id="roundtrip03" name="medical_history3" value="Diabetes with complications">
 						<label for="roundtrip03">Diabetes with complications</label>
 						<br>

 						<input class="sym-checkbox" type="checkbox" id="roundtrip04" name="medical_history4"
 							value="Disease or conditions that make it harder to cough">
 						<label for="roundtrip04">Disease or conditions that affect cough</label>
 						<br>

 						<input class="sym-checkbox" type="checkbox" id="roundtrip05" name="medical_history5" value="Congestive heart failure">
 						<label for="roundtrip05">Congestive heart failure</label>

 						<br>

 						<input class="sym-checkbox" type="checkbox" id="roundtrip07" name="medical_history7" value="Extreme obesity">
 						<label for="roundtrip07">Extreme obesity</label>
 						<br>

 						<input class="sym-checkbox" type="checkbox" id="roundtrip08" name="medical_history8" value="Cough due to other medical conditions">
 						<label for="roundtrip08">Cough due to other medical conditions</label>
 						<br>


 						<input class="sym-checkbox sym-none" type="checkbox" id="roundtrip09" name="medical_history9" value="None">
 						<label for="roundtrip09">None</label>

 					</div>
 				</div>
					<!-- Break -->
					<br>
					<br>
					<div class="12u$">
						<ul class="actions">
							<li><input type="button" value="Submit" id="submit" onclick="submit_data()" /></li>
							<li><input type="reset" value="Reset" /></li>
							<li><input type="button" value="Feedback" id="feedback" onclick="redirect_to_feedback()" /></li>
						</ul>
					</div>
					<!--
					<div class="is-required">
						<p><button id="resetbtn">new user</button>
					</div>
				-->
				</div>
			</form>
			<hr />

	</section>

	<!-- Footer -->
	<footer id="footer">
		<div class="inner">
			<!-- GitHub and other icons -->
			<div class="footer-icons" id="contact">
				<a href="https://github.com/virufy" target="_blank">
					<i class="icon fa-github fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://www.linkedin.com/company/virufy/" target="_blank">
					<i class="icon fab fa-linkedin-in fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://twitter.com/VirufyOrg" target="_blank">
				<i class="icon fa-twitter fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://www.facebook.com/Virufy/" target="_blank">
					<i class="icon fab fa-facebook-f fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://www.instagram.com/virufyorg/" target="_blank">
					<i class="icon fab fa-instagram fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a class="hidden-mail" data-username="info" data-inline="false">
					<i class="fas fa-envelope fa-2x"></i>
				</a>
			</div>

			<div class="copyright">
				&copy; Copyright 2020 Virufy. All rights reserved.
				<br>Built with <a href="https://templated.co/projection">Projection from Templated.</a>
			</div>
		</div>
	</footer>

	<!-- Scripts -->

	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="/__/firebase/7.16.0/firebase-app.js"></script>
	<!-- TODO: Add SDKs for Firebase products that you want to use
	https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="/__/firebase/7.16.0/firebase-analytics.js"></script>
	<!-- Initialize Firebase -->
	<script src="/__/firebase/init.js"></script>
	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/skel.min.js"></script>
	<script src="assets/js/util.js"></script>
	<script src="assets/js/main.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.js"></script>
	<script>

        $('#sym-checkbox-wrapper .sym-checkbox').on('change', function () {
            let $this = $(this);
            if ($this.prop('checked')) {
                if ($this.is('.sym-none')) {
                    $this.siblings().prop('checked', false);
                } else {
                    $this.siblings('.sym-none').prop('checked', false);
                }
            }
        });


        const sleep = async (msec) => new Promise((resolve) => setTimeout(resolve, msec));

function resetUserID () {
	localStorage.removeItem("virufy-userid");
	//alert("reset userid");
	localStorage.removeItem("virufy-age");
};
function initFormData () {
	if (localStorage.getItem("virufy-age")) {
		age.value = localStorage.getItem("virufy-age");
	}
};

//resetbtn.onclick = () => resetUserID();
window.onload = () => {
	initFormData();
};

async function uploadAudio () {
  for (;;) {
    try {
			// const url = "http://localhost:8899/";
			const url = "https://voice.sabae.cc/";
			const formdata = new FormData(myForm)
			if (blob_arr_count.length>0){
				formdata.append("count_audio", blob_arr_count[0], "count.wav");
			}
			if (blob_arr.length > 0) {
				formdata.append("cough_audio", blob_arr[0], "cough.wav");
			}

			if (age.value != localStorage.getItem("virufy-age")) {
				 resetUserID();
			}
			let userid = localStorage.getItem("virufy-userid");
			if (!userid) {
				userid = Math.random().toString() + "-" + new Date().getTime();
				formdata.append("userid", userid);
				localStorage.setItem("virufy-userid", userid);
			} else {
				formdata.append("userid", userid);
			}

			// save the value of Age
			if (!localStorage.getItem("virufy-age")){
				localStorage.setItem("virufy-age", age.value);
			}

      const res = await (await fetch(url, { method: 'POST', body: formdata })).json()
      console.log(res)
      if (res.res == 'ok') {
        return res.id
      }
			alert("upload error, retry? (" + res.res + ") tap to retry");
    } catch (e) {
			alert("upload error, retry? (" + e + ") tap to retry");
			break;
    }
		await sleep(500);
  }
}

		async function submit_data() {
			await uploadAudio();
			const msg = "Thank you for donating your cough!"
			swal({
				title: "Thank You!",
				text: msg,
				html: true,
				confirmButtonClass: "button",
				confirmButtonText: "Go to feedback form",
				allowOutsideClick: true,
			},
			function() {
				window.location.href="https://forms.gle/zzb9doND2SVQQv11A";
			});
		}

		async function redirect_to_feedback(){
			window.open("https://forms.gle/zzb9doND2SVQQv11A");
		}


		function show_instructions_video() {
			swal({
				title: "Instructions - Video Record",
				text: "<p>(1) wipe the fingertip with alcohol<br> (2) press the fingertip lightly onto the smartphone camera such that the entire lens is covered, as show below </p><br><img src='images/videoInstructions.png' alt='video instructions' class='modal-instructions'/>",
				html: true,
				button: "Ok"
			});
		}

	</script>

	<script>
		i18nManager(function() {
			$('body').localize();
		})
	</script>

	<!-- inserting these scripts at the end to be able to use all the elements in the DOM -->
	<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
	<script src="assets/js/app.js"></script>
</body>

</html>
