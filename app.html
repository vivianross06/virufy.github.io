<!DOCTYPE HTML>
<!--
	Projection by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>

<head>
	<meta http-equiv="refresh" content="0; url=https://form.jotform.com/virufy2/virufy-covid-19-study">
	<!-- Hotjar Tracking Code for virufy.org -->
	<script>
	    (function(h,o,t,j,a,r){
	        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
	        h._hjSettings={hjid:1878866,hjsv:6};
	        a=o.getElementsByTagName('head')[0];
	        r=o.createElement('script');r.async=1;
	        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
	        a.appendChild(r);
	    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
	</script>

	<title>Virufy - App</title>

	<!-- Metatags -->
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Crowdsourced AI-based COVID-19 Detection">
	<meta name="author" content="Team Virufy">

	<link rel="stylesheet" href="assets/css/main.css" />
		<script src="https://kit.fontawesome.com/828decba15.js" crossorigin="anonymous"></script>

	<!--Sweet Alert-->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.css" rel="stylesheet" />

	<!-- Favicon -->
	<link rel="icon" href="images/logo2.png" type="image/x-icon" />
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-165690517-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];

		function gtag() {
			dataLayer.push(arguments);
		}
		gtag('js', new Date());

		gtag('config', 'UA-165690517-1');

	</script>

</head>

<body>

	<!-- Header -->
	<header id="header">
		<div class="inner">
			<a href="index.html" class="logo">
				<img src="images/logo2.png">
			</a>
			<nav id="nav">
				<a href="index.html">Home</a>
				<a href="./index.html#about">About</a>
				<a href="./app.html">App</a>
				<a href="./research.html">Research</a>
				<a href="data.html">Open Data</a>
				<a href="./team.html">Team</a>
				<a href="./goals.html">Goals</a>
				<a href="./join.html">Join Us</a>
				<a href="./oyw.html">One Young World</a>
				<a href="https://blog.virufy.org/">Blog</a>
				<a href="https://www.gofundme.com/f/virufyorg" target="_blank"><button>Donate</button>
				</a>
			</nav>
			<a href="#navPanel" class="navPanelToggle"><span class="fa fa-bars"></span></a>
		</div>
	</header>

	<!-- Banner - Message and icon -->
	<section id="app-banner">
		<div class="inner">
			<header>
				<h1>Virufy COVID-19 (Beta)</h1>
			</header>
		</div>
	</section>


	<!-- Main -->
	<section id="main">
		<div>
			<br>
			<br>
			<br>
			<br>
		<p style="text-align:center;">Please click <a href="https://form.jotform.com/virufy2/virufy-covid-19-study" target=_blank>here</a> to donate
			your cough if you are not redirected.</p>
			<br>
			<br>
			<br>
		</div>
	</section>

	<!-- Footer -->
	<footer id="footer">
		<div class="inner">
			<!-- GitHub and other icons -->
			<div class="footer-icons" id="contact">
				<a href="https://github.com/virufy" target="_blank">
					<i class="icon fa-github fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://www.linkedin.com/company/virufy/" target="_blank">
					<i class="icon fab fa-linkedin-in fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://twitter.com/VirufyOrg" target="_blank">
				<i class="icon fa-twitter fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://www.facebook.com/Virufy/" target="_blank">
					<i class="icon fab fa-facebook-f fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a href="https://www.instagram.com/virufyorg/" target="_blank">
					<i class="icon fab fa-instagram fa-2x"></i>
				</a>&nbsp;&nbsp;
				<a class="hidden-mail" data-username="info" data-inline="false">
					<i class="fas fa-envelope fa-2x"></i>
				</a>
			</div>

			<div class="copyright">
				&copy; Copyright 2020 Virufy. All rights reserved.
				<br>Built with <a href="https://templated.co/projection">Projection from Templated.</a>
			</div>
		</div>
	</footer>

	<!-- Scripts -->

	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="/__/firebase/7.16.0/firebase-app.js"></script>
	<!-- TODO: Add SDKs for Firebase products that you want to use
	https://firebase.google.com/docs/web/setup#available-libraries -->
	<script src="/__/firebase/7.16.0/firebase-analytics.js"></script>
	<!-- Initialize Firebase -->
	<script src="/__/firebase/init.js"></script>
	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/skel.min.js"></script>
	<script src="assets/js/util.js"></script>
	<script src="assets/js/main.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.js"></script>
	<script>

        $('#sym-checkbox-wrapper .sym-checkbox').on('change', function () {
            let $this = $(this);
            if ($this.prop('checked')) {
                if ($this.is('.sym-none')) {
                    $this.siblings().prop('checked', false);
                } else {
                    $this.siblings('.sym-none').prop('checked', false);
                }
            }
        });


        const sleep = async (msec) => new Promise((resolve) => setTimeout(resolve, msec));

function resetUserID () {
	localStorage.removeItem("virufy-userid");
	//alert("reset userid");
	localStorage.removeItem("virufy-age");
};
function initFormData () {
	if (localStorage.getItem("virufy-age")) {
		age.value = localStorage.getItem("virufy-age");
	}
};

//resetbtn.onclick = () => resetUserID();
window.onload = () => {
	initFormData();
};

async function uploadAudio () {
  for (;;) {
    try {
			// const url = "http://localhost:8899/";
			const url = "https://voice.sabae.cc/";
			const formdata = new FormData(myForm)
			if (blob_arr_count.length>0){
				formdata.append("count_audio", blob_arr_count[0], "count.wav");
			}
			if (blob_arr.length > 0) {
				formdata.append("cough_audio", blob_arr[0], "cough.wav");
			}

			if (age.value != localStorage.getItem("virufy-age")) {
				 resetUserID();
			}
			let userid = localStorage.getItem("virufy-userid");
			if (!userid) {
				userid = Math.random().toString() + "-" + new Date().getTime();
				formdata.append("userid", userid);
				localStorage.setItem("virufy-userid", userid);
			} else {
				formdata.append("userid", userid);
			}

			// save the value of Age
			if (!localStorage.getItem("virufy-age")){
				localStorage.setItem("virufy-age", age.value);
			}

      const res = await (await fetch(url, { method: 'POST', body: formdata })).json()
      console.log(res)
      if (res.res == 'ok') {
        return res.id
      }
			alert("upload error, retry? (" + res.res + ") tap to retry");
    } catch (e) {
			alert("upload error, retry? (" + e + ") tap to retry");
			break;
    }
		await sleep(500);
  }
}

		async function submit_data() {
			await uploadAudio();
			const msg = "Thank you for donating your cough!"
			swal({
				title: "Thank You!",
				text: msg,
				html: true,
				confirmButtonClass: "button",
				confirmButtonText: "Go to feedback form",
				allowOutsideClick: true,
			},
			function() {
				window.location.href="https://forms.gle/zzb9doND2SVQQv11A";
			});
		}

		async function redirect_to_feedback(){
			window.open("https://forms.gle/zzb9doND2SVQQv11A");
		}


		function show_instructions_video() {
			swal({
				title: "Instructions - Video Record",
				text: "<p>(1) wipe the fingertip with alcohol<br> (2) press the fingertip lightly onto the smartphone camera such that the entire lens is covered, as show below </p><br><img src='images/videoInstructions.png' alt='video instructions' class='modal-instructions'/>",
				html: true,
				button: "Ok"
			});
		}

	</script>

	<!-- inserting these scripts at the end to be able to use all the elements in the DOM -->
	<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
	<script src="assets/js/app.js"></script>
</body>

</html>
